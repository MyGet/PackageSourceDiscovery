<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>FeedDiscovery by myget</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>FeedDiscovery</h1>
        <p>The NuGet Feed Discovery Specification</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/myget/FeedDiscovery" class="button fork"><strong>View On GitHub</strong></a>
        <div class="downloads">
          <span>Downloads:</span>
          <ul>
            <li><a href="https://github.com/myget/FeedDiscovery/zipball/master" class="button">ZIP</a></li>
            <li><a href="https://github.com/myget/FeedDiscovery/tarball/master" class="button">TAR</a></li>
          </ul>
        </div>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1>NuGet Feed Discovery 1.0.0-alpha001</h1>

<p>NuGet Feed Discovery (NFD) allows for NuGet-based clients tools to discover the feeds that are hosted by a user or organization.</p>

<p>NuGet Feed Discovery is an attempt to remove friction from the following scenarios:</p>

<ul>
<li>An individual user may have several NuGet feeds spread across the Internet. Some may be on NuGet.org (including curated feeds), some on MyGet and maybe some on my corporate network. How do I easily point my Visual Studio to all my feeds accross different machines? And how do I maintain this configuration?</li>
<li>An organization may have several feeds internally as well as one on MyGet and some CI packages on TeamCity. How can this organization tell his developers what feeds they can/should use?</li>
<li>An organization may have a NuGet server containing multiple feeds. How will developers in this organization get a list of available feeds and services?</li>
</ul><p>For both scenarios, a simple feed discovery mechanism could facilitate this. Such feed discovery mechanism could be any URL out there (even multiple per host).</p>

<p>As an example, we've implemented the above. Open Visual Studio and open any solution. Then issue the following in the Package Manager Console:</p>

<div class="highlight"><pre><span class="n">Install-Package</span> <span class="n">DiscoverPackageSources</span>
<span class="n">Discover-PackageSources</span> <span class="n">-Url</span> <span class="s2">"http://www.myget.org/gallery"</span>
</pre></div>

<p>Close and re-open Visual Studio and check your package sources. The URL has been verified for a NFD manifest URL and the manifest has been parsed. Matching feeds have been installed into the NuGet.config file, in this case all feeds listed in the MyGet gallery.</p>

<h2>Request</h2>

<p>An NFD request is an HTTP GET to an NDF manifest file with optional authentication and an optional NuGet-ApiKey HTTP Header. There are no filtering or searching options at this time.</p>

<h2>Response</h2>

<p>The response will be an XML document following the <strong>Really Simple Discovery</strong> (RSD) RFC as described on <a href="https://github.com/danielberlinger/rsd">https://github.com/danielberlinger/rsd</a>. Since not all required metadata can be obtained from the RSD format, the <a href="http://dublincore.org/documents/2012/06/14/dcmi-terms/?v=elements">Dublin Core schema</a> is present in the NFD response as well.</p>

<p>Vendors and open source projects are allowed to add their own schema to the NFD discovery document however the manifest described below should be respected at all times.</p>

<p>An example manifest could be:</p>

<div class="highlight"><pre><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;rsd</span> <span class="na">version=</span><span class="s">"1.0"</span> <span class="na">xmlns:dc=</span><span class="s">"http://purl.org/dc/elements/1.1/"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;service&gt;</span>
    <span class="nt">&lt;engineName&gt;</span>MyGet<span class="nt">&lt;/engineName&gt;</span>
    <span class="nt">&lt;engineLink&gt;</span>http://www.myget.org<span class="nt">&lt;/engineLink&gt;</span>

    <span class="nt">&lt;dc:identifier&gt;</span>http://www.myget.org/F/googleanalyticstracker<span class="nt">&lt;/dc:identifier&gt;</span>    
    <span class="nt">&lt;dc:creator&gt;</span>maartenba<span class="nt">&lt;/dc:creator&gt;</span>    
    <span class="nt">&lt;dc:owner&gt;</span>maartenba<span class="nt">&lt;/dc:owner&gt;</span>
    <span class="nt">&lt;dc:title&gt;</span>Staging feed for GoogleAnalyticsTracker<span class="nt">&lt;/dc:title&gt;</span>
    <span class="nt">&lt;dc:description&gt;</span>Staging feed for GoogleAnalyticsTracker<span class="nt">&lt;/dc:description&gt;</span> 
    <span class="nt">&lt;homePageLink&gt;</span>http://www.myget.org/gallery/googleanalyticstracker<span class="nt">&lt;/homePageLink&gt;</span>

    <span class="nt">&lt;apis&gt;</span>
      <span class="nt">&lt;api</span> <span class="na">name=</span><span class="s">"nuget-v2-packages"</span> <span class="na">preferred=</span><span class="s">"true"</span> <span class="na">apiLink=</span><span class="s">"http://www.myget.org/F/googleanalyticstracker/api/v2"</span> <span class="na">blogID=</span><span class="s">""</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;api</span> <span class="na">name=</span><span class="s">"nuget-v2-push"</span> <span class="na">preferred=</span><span class="s">"true"</span> <span class="na">apiLink=</span><span class="s">"http://www.myget.org/F/googleanalyticstracker/api/v2/package"</span> <span class="na">blogID=</span><span class="s">""</span><span class="nt">&gt;</span>
        <span class="nt">&lt;settings&gt;</span>
          <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">"apiKey"</span><span class="nt">&gt;</span>abcdefghijkl<span class="nt">&lt;/setting&gt;</span>
        <span class="nt">&lt;/settings&gt;</span>
      <span class="nt">&lt;/api&gt;</span>
      <span class="nt">&lt;api</span> <span class="na">name=</span><span class="s">"nuget-v1-packages"</span> <span class="na">preferred=</span><span class="s">"false"</span> <span class="na">apiLink=</span><span class="s">"http://www.myget.org/F/googleanalyticstracker/api/v1"</span> <span class="na">blogID=</span><span class="s">""</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/apis&gt;</span>
  <span class="nt">&lt;/service&gt;</span>
<span class="nt">&lt;/rsd&gt;</span>
</pre></div>

<p>The following table describes the elements in the data format:</p>

<table>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
<tr>
<td>engineName</td>
<td>Optional: the software on which the feed is running</td>
</tr>
<tr>
<td>engineLink</td>
<td>Optional: the URL to the website of the software on which the feed is running</td>
</tr>
<tr>
<td>dc:identifier</td>
<td>
<b>Required</b> - a globally unique URN/URL identifying he feed</td>
</tr>
<tr>
<td>dc:owner</td>
<td>Optional: the owner of the feed</td>
</tr>
<tr>
<td>dc:creator</td>
<td>Optional: the creator of the feed</td>
</tr>
<tr>
<td>dc:title</td>
<td>
<b>Required</b> - feed name</td>
</tr>
<tr>
<td>dc:description</td>
<td>Optional: feed description</td>
</tr>
<tr>
<td>homePageLink</td>
<td>Optional: link to an HTML representation of the feed</td>
</tr>
<tr>
<td>apis</td>
<td>
<b>Required</b> - a list of endpoints for the feed</td>
</tr>
<tr>
<td>name</td>
<td>
<b>Required</b> - the feed protocol used<br><br>
Proposed values:<br><ul>
<li>nuget-v1-packages (Orchard)</li>
<li>nuget-v2-packages (current NuGet protocol)</li>
<li>nuget-v2-push (package push URL)</li>
<li>symbols-v1 (current SymbolSource implementation)</li>
</ul>
Note that this list can be extended at will (e.g. chocolatey-v1 or proget-v2). Clients can decide which versions they support.
</td>
</tr>
<tr>
<td>preferred</td>
<td>
<b>Required</b> - is this the preferred endpoint to communicate with the feed?</td>
</tr>
<tr>
<td>apiLink</td>
<td>
<b>Required</b> - the GET URL</td>
</tr>
<tr>
<td>blogID</td>
<td>
<b>Required</b> - for compatibility with RSD spec, not used: leave BLANK</td>
</tr>
</table><p>The <code>&lt;api /&gt;</code> element can contain zero, one or more <code>&lt;setting name="key"&gt;value&lt;/setting&gt;</code> elements specifying settings such as <code>requireAuthentication</code>, <code>apiKey</code> and vendor-specific settings.</p>

<h2>Server Implementation Guidelines</h2>

<h3>Feed Uniqueness</h3>

<p>Feed uniqueness must be global. <code>urn:&lt;guid&gt;</code> or the feed URL can be valid identifiers.</p>

<p>All feeds should contain an Id.</p>

<h3>Feed Visibility / Access Control</h3>

<p>All feeds that the requesting user has read access to should be returned. If the user is anonymous, feeds that require authentication should be omitted.</p>

<p>If the user is logged in, either controlled by basic authentication or using the <code>NuGet-ApiKey</code> HttpHeader, the server should return every feed the user has access to as well as feed specific settings such as API keys and so on. The NFD client can use these specifics to preconfigure the NuGet.config file on the user's machine.</p>

<h2>Client / Consumer Implementation Guidelines</h2>

<p>The client should respect the following flow of discovering feeds:</p>

<ul>
<li>If no NFD is given, the client should assume <code>http://nuget.&lt;currentdomain&gt;</code> as the NFD server.</li>
<li>
<p>The NFD URL is accesses and downloaded. It can contain:</p>

<ul>
<li>HTML containing a tag such as </li>
</ul>
<div class="highlight"><pre><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"nuget"</span> 
      <span class="na">type=</span><span class="s">"application/rsd+xml"</span> 
      <span class="na">title=</span><span class="s">"GoogleAnalyticsTracker feed on MyGet"</span> 
      <span class="na">href=</span><span class="s">"http://myget.org/discovery/feed/googleanalyticstracker"</span><span class="nt">/&gt;</span>
</pre></div>

<p>This URL should be followed and the NFD manifest parsed. Note that multiple tags may exist and should all be parsed.</p>

<ul>
<li>HTML containing a tag such as</li>
</ul>
<div class="highlight"><pre><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"nuget"</span> 
      <span class="na">type=</span><span class="s">"application/atom+xml"</span> 
      <span class="na">title=</span><span class="s">"WebMatrix Package Source"</span> 
      <span class="na">href=</span><span class="s">"http://nuget.org/api/v2/curated-feeds/WebMatrix/Packages"</span><span class="nt">/&gt;</span>
</pre></div>

<p>This URL should be treated as a NuGet feed and added as-is, using the title attribute as the feed's title in NuGet package source list. No further metadata can be discovered for this feed. Note that multiple tags may exist.</p>

<ul>
<li>If the URL directly points to a NuGet Feed Discovery Manifest, we can immediately parse it.</li>
</ul>
</li>
</ul><p>The client should support entry of a complete NFD URL <code>&lt;protocol&gt;://&lt;host name&gt;:&lt;port&gt;/&lt;path&gt;</code> but require only that the host name be entered. When less than a full URL is entered, the client should verify if the host returns a NFD manifest or contains a <code>&lt;link rel="nuget"/&gt;</code> tag.</p>

<p>Depending on security, consuming an NFD manifest using the <code>NuGet-ApiKey</code> header or using basic authentication may yield additional endpoints and API settings. For example, MyGet produces the following manifest on an anonymous call to <a href="https://www.myget.org/Discovery/Feed/googleanalyticstracker:">https://www.myget.org/Discovery/Feed/googleanalyticstracker:</a></p>

<div class="highlight"><pre><span class="nt">&lt;rsd</span> <span class="na">version=</span><span class="s">"1.0"</span> <span class="na">xmlns:dc=</span><span class="s">"http://purl.org/dc/elements/1.1/"</span> <span class="na">xmlns=</span><span class="s">"http://archipelago.phrasewise.com/rsd"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;service&gt;</span>
    <span class="nt">&lt;engineName&gt;</span>MyGet<span class="nt">&lt;/engineName&gt;</span>
    <span class="nt">&lt;engineLink&gt;</span>http://www.myget.org/<span class="nt">&lt;/engineLink&gt;</span>
    <span class="nt">&lt;dc:identifier&gt;</span>http://www.myget.org/F/googleanalyticstracker/<span class="nt">&lt;/dc:identifier&gt;</span>
    <span class="nt">&lt;dc:owner&gt;</span>maartenba<span class="nt">&lt;/dc:owner&gt;</span>
    <span class="nt">&lt;dc:creator&gt;</span>maartenba<span class="nt">&lt;/dc:creator&gt;</span>
    <span class="nt">&lt;dc:title&gt;</span>Staging feed for GoogleAnalyticsTracker<span class="nt">&lt;/dc:title&gt;</span>
    <span class="nt">&lt;dc:description&gt;</span>Staging feed for GoogleAnalyticsTracker<span class="nt">&lt;/dc:description&gt;</span>
    <span class="nt">&lt;homePageLink&gt;</span>http://www.myget.org/Feed/Details/googleanalyticstracker/<span class="nt">&lt;/homePageLink&gt;</span>
    <span class="nt">&lt;apis&gt;</span>
      <span class="nt">&lt;api</span> <span class="na">name=</span><span class="s">"nuget-v2-packages"</span> <span class="na">blogID=</span><span class="s">""</span> <span class="na">preferred=</span><span class="s">"true"</span> <span class="na">apiLink=</span><span class="s">"http://www.myget.org/F/googleanalyticstracker/"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;api</span> <span class="na">name=</span><span class="s">"nuget-v1-packages"</span> <span class="na">blogID=</span><span class="s">""</span> <span class="na">preferred=</span><span class="s">"false"</span> <span class="na">apiLink=</span><span class="s">"http://www.myget.org/F/googleanalyticstracker/api/v1/"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/apis&gt;</span>
  <span class="nt">&lt;/service&gt;</span>
<span class="nt">&lt;/rsd&gt;</span>
</pre></div>

<p>The authenticated version of <a href="https://www.myget.org/Discovery/Feed/googleanalyticstracker">https://www.myget.org/Discovery/Feed/googleanalyticstracker</a> yields:</p>

<div class="highlight"><pre><span class="nt">&lt;rsd</span> <span class="na">version=</span><span class="s">"1.0"</span> <span class="na">xmlns:dc=</span><span class="s">"http://purl.org/dc/elements/1.1/"</span> <span class="na">xmlns=</span><span class="s">"http://archipelago.phrasewise.com/rsd"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;service&gt;</span>
    <span class="nt">&lt;engineName&gt;</span>MyGet<span class="nt">&lt;/engineName&gt;</span>
    <span class="nt">&lt;engineLink&gt;</span>http://www.myget.org/<span class="nt">&lt;/engineLink&gt;</span>
    <span class="nt">&lt;dc:identifier&gt;</span>http://www.myget.org/F/googleanalyticstracker/<span class="nt">&lt;/dc:identifier&gt;</span>
    <span class="nt">&lt;dc:owner&gt;</span>maartenba<span class="nt">&lt;/dc:owner&gt;</span>
    <span class="nt">&lt;dc:creator&gt;</span>maartenba<span class="nt">&lt;/dc:creator&gt;</span>
    <span class="nt">&lt;dc:title&gt;</span>Staging feed for GoogleAnalyticsTracker<span class="nt">&lt;/dc:title&gt;</span>
    <span class="nt">&lt;dc:description&gt;</span>Staging feed for GoogleAnalyticsTracker<span class="nt">&lt;/dc:description&gt;</span>
    <span class="nt">&lt;homePageLink&gt;</span>http://www.myget.org/Feed/Details/googleanalyticstracker/<span class="nt">&lt;/homePageLink&gt;</span>
    <span class="nt">&lt;apis&gt;</span>
      <span class="nt">&lt;api</span> <span class="na">name=</span><span class="s">"nuget-v2-packages"</span> <span class="na">blogID=</span><span class="s">""</span> <span class="na">preferred=</span><span class="s">"true"</span> <span class="na">apiLink=</span><span class="s">"http://www.myget.org/F/googleanalyticstracker/"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;api</span> <span class="na">name=</span><span class="s">"nuget-v1-packages"</span> <span class="na">blogID=</span><span class="s">""</span> <span class="na">preferred=</span><span class="s">"false"</span> <span class="na">apiLink=</span><span class="s">"http://www.myget.org/F/googleanalyticstracker/api/v1/"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;api</span> <span class="na">name=</span><span class="s">"nuget-v2-push"</span> <span class="na">blogID=</span><span class="s">""</span> <span class="na">preferred=</span><span class="s">"true"</span> <span class="na">apiLink=</span><span class="s">"http://www.myget.org/F/googleanalyticstracker/"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;settings&gt;</span>
          <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">"apiKey"</span><span class="nt">&gt;</span>530c14a6-6ce5-47d0-8f14-9daab627aa38<span class="nt">&lt;/setting&gt;</span>
        <span class="nt">&lt;/settings&gt;</span>
      <span class="nt">&lt;/api&gt;</span>
      <span class="nt">&lt;api</span> <span class="na">name=</span><span class="s">"symbols-v2-push"</span> <span class="na">blogID=</span><span class="s">""</span> <span class="na">preferred=</span><span class="s">"true"</span> <span class="na">apiLink=</span><span class="s">"http://nuget.gw.symbolsource.org/MyGet/googleanalyticstracker"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;settings&gt;</span>
          <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">"apiKey"</span><span class="nt">&gt;</span>abcdefghijklmnop<span class="nt">&lt;/setting&gt;</span>
        <span class="nt">&lt;/settings&gt;</span>
      <span class="nt">&lt;/api&gt;</span>
    <span class="nt">&lt;/apis&gt;</span>
  <span class="nt">&lt;/service&gt;</span>
<span class="nt">&lt;/rsd&gt;</span>
</pre></div>

<h2>Example Client / Consumer implementation</h2>

<p>The following Client/Consumer implementation only discovers feed endpoints for consuming packages. Push, symbols and API setting elements are ignored. A package producer should probably discover push endpoints as well and store the provided API key for future use.
The Client/Consumer is implemented using PowerShell.</p>

<div class="highlight"><pre><span class="k">function</span> <span class="nb">Add-PackageSource</span> <span class="p">{</span>
    <span class="k">param</span><span class="p">(</span>
    <span class="p">[</span><span class="k">parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$true</span><span class="p">)]</span>
        <span class="no">[string]</span><span class="nv">$Name</span><span class="p">,</span>
        <span class="p">[</span><span class="k">parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$true</span><span class="p">)]</span>
        <span class="no">[string]</span><span class="nv">$Source</span>
    <span class="p">)</span>   

    <span class="nv">$configuration</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="s2">"$env:AppData\NuGet\NuGet.config"</span>
    <span class="nv">$configurationXml</span> <span class="p">=</span> <span class="no">[xml]</span><span class="nv">$configuration</span>

    <span class="nv">$sourceToAdd</span> <span class="p">=</span> <span class="nv">$configurationXml</span><span class="p">.</span><span class="n">createElement</span><span class="p">(</span><span class="s2">"add"</span><span class="p">)</span>
    <span class="nv">$sourceToAdd</span><span class="p">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s2">"key"</span><span class="p">,</span> <span class="nv">$Name</span><span class="p">)</span><span class="err">;</span>
    <span class="nv">$sourceToAdd</span><span class="p">.</span><span class="n">SetAttribute</span><span class="p">(</span><span class="s2">"value"</span><span class="p">,</span> <span class="nv">$Source</span><span class="p">)</span><span class="err">;</span>
    <span class="nv">$configurationXml</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="n">packageSources</span><span class="p">.</span><span class="n">appendChild</span><span class="p">(</span><span class="nv">$sourceToAdd</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Out-Null</span>

    <span class="nv">$configurationXml</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="s2">"$env:AppData\NuGet\NuGet.config"</span><span class="p">)</span>

    <span class="nb">Write-Host</span> <span class="s2">"Added feed `"$Name`" ($Source)"</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nb">Get-PackageSource</span> <span class="p">{</span>
    <span class="k">param</span><span class="p">(</span>
        <span class="p">[</span><span class="k">parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">)]</span>
        <span class="no">[string]</span><span class="nv">$Name</span>
    <span class="p">)</span>   

    <span class="nv">$configuration</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="s2">"$env:AppData\NuGet\NuGet.config"</span>
    <span class="nv">$configurationXml</span> <span class="p">=</span> <span class="no">[xml]</span><span class="nv">$configuration</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$Name</span> <span class="o">-ne</span> <span class="nv">$null</span> <span class="o">-and</span> <span class="nv">$Name</span> <span class="o">-ne</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$configurationXml</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="n">packageSources</span><span class="p">.</span><span class="n">add</span> <span class="p">|</span> <span class="n">where</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">key</span> <span class="o">-eq</span> <span class="nv">$Name</span><span class="p">}</span> <span class="p">|</span> <span class="nb">Format-Table</span> <span class="err">@</span><span class="p">{</span><span class="n">Label</span><span class="p">=</span><span class="s2">"Name"</span><span class="err">;</span> <span class="n">Expression</span><span class="p">={</span><span class="nv">$_</span><span class="p">.</span><span class="n">key</span><span class="p">}},</span> <span class="err">@</span><span class="p">{</span><span class="n">Label</span><span class="p">=</span><span class="s2">"Source"</span><span class="err">;</span> <span class="n">Expression</span><span class="p">={</span><span class="nv">$_</span><span class="p">.</span><span class="n">value</span><span class="p">}}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$null</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">Discover-PackageSources</span> <span class="p">{</span>
    <span class="k">param</span><span class="p">(</span>
        <span class="p">[</span><span class="k">parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">)]</span>
        <span class="no">[string]</span><span class="nv">$Url</span><span class="p">,</span>
        <span class="p">[</span><span class="k">parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">)]</span>
        <span class="no">[string]</span><span class="nv">$Username</span><span class="p">,</span> 
        <span class="p">[</span><span class="k">parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">)]</span>
        <span class="no">[string]</span><span class="nv">$Password</span><span class="p">,</span> 
        <span class="p">[</span><span class="k">parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">)]</span>
        <span class="no">[string]</span><span class="nv">$ApiKey</span><span class="p">,</span> 
        <span class="p">[</span><span class="k">parameter</span><span class="p">(</span><span class="k">Mandatory</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">)]</span>
        <span class="no">[string]</span><span class="nv">$Title</span>
    <span class="p">)</span>   

    <span class="k">if</span> <span class="p">(</span><span class="nv">$Url</span> <span class="o">-eq</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$dnsDomains</span> <span class="p">=</span> <span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_NetworkAdapterConfiguration</span> <span class="n">-Filter</span> <span class="n">IPEnabled</span><span class="p">=</span><span class="n">TRUE</span> <span class="n">-ComputerName</span> <span class="p">.</span> <span class="p">|</span> <span class="p">%{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">DNSDomain</span> <span class="p">}</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$dnsDomain</span> <span class="k">in</span> <span class="nv">$dnsDomains</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$autoDiscoveryUrl</span> <span class="p">=</span> <span class="s2">"http://nuget.$dnsDomain"</span>
            <span class="nb">Write-Host</span> <span class="s2">"Trying feed autodiscovery from $autoDiscoveryUrl..."</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="n">Discover-PackageSources</span> <span class="n">-Url</span> <span class="nv">$autoDiscoveryUrl</span> <span class="n">-Username</span> <span class="nv">$Username</span> <span class="n">-Password</span> <span class="nv">$Password</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                <span class="nb">Write-Host</span> <span class="s2">"Could not autodiscover feeds."</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nv">$relRegex</span> <span class="p">=</span> <span class="s2">"&lt;\s*link\s*[^&gt;]*?rel\s*=\s*[`"']*([^`"'&gt;]+)[^&gt;]*?&gt;"</span>
    <span class="nv">$hrefRegex</span> <span class="p">=</span> <span class="s2">"&lt;\s*link\s*[^&gt;]*?href\s*=\s*[`"']*([^`"'&gt;]+)[^&gt;]*?&gt;"</span>
    <span class="nv">$titleRegex</span> <span class="p">=</span> <span class="s2">"&lt;\s*link\s*[^&gt;]*?title\s*=\s*[`"']*([^`"'&gt;]+)[^&gt;]*?&gt;"</span>

    <span class="nv">$data</span> <span class="p">=</span> <span class="nv">$null</span>

    <span class="nv">$webclient</span> <span class="p">=</span> <span class="nb">new-object</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$Username</span> <span class="o">-ne</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
       <span class="nv">$credentials</span> <span class="p">=</span> <span class="no">[System.Convert]</span><span class="err">::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="no">[System.Text.Encoding]</span><span class="err">::</span><span class="n">ASCII</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="nv">$Username</span> <span class="p">+</span> <span class="s2">":"</span> <span class="p">+</span> <span class="nv">$Password</span><span class="p">))</span>
        <span class="nv">$webClient</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s2">"Authorization"</span><span class="p">,</span> <span class="s2">"Basic $credentials"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$ApiKey</span> <span class="o">-ne</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$webClient</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s2">"X-NuGet-ApiKey"</span><span class="p">,</span> <span class="nv">$ApiKey</span><span class="p">)</span> <span class="c"># for backwards compatibility</span>
        <span class="nv">$webClient</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s2">"NuGet-ApiKey"</span><span class="p">,</span> <span class="nv">$ApiKey</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nv">$data</span> <span class="p">=</span> <span class="nv">$webclient</span><span class="p">.</span><span class="n">DownloadString</span><span class="p">(</span><span class="nv">$Url</span><span class="p">)</span>

    <span class="nv">$resultingMatches</span> <span class="p">=</span> <span class="no">[Regex]</span><span class="err">::</span><span class="n">Matches</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$hrefRegex</span><span class="p">,</span> <span class="s2">"IgnoreCase"</span><span class="p">)</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$match</span> <span class="k">in</span> <span class="nv">$resultingMatches</span><span class="p">)</span> <span class="p">{</span>
       <span class="nv">$rel</span> <span class="p">=</span> <span class="no">[Regex]</span><span class="err">::</span><span class="n">Match</span><span class="p">(</span><span class="nv">$match</span><span class="p">,</span> <span class="nv">$relRegex</span><span class="p">,</span> <span class="s2">"IgnoreCase"</span><span class="p">).</span><span class="n">Groups</span><span class="p">[</span><span class="n">1</span><span class="p">].</span><span class="n">Value</span>
       <span class="nv">$href</span> <span class="p">=</span> <span class="nv">$match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="n">1</span><span class="p">].</span><span class="n">Value</span>
       <span class="nv">$title</span> <span class="p">=</span> <span class="no">[Regex]</span><span class="err">::</span><span class="n">Match</span><span class="p">(</span><span class="nv">$match</span><span class="p">,</span> <span class="nv">$titleRegex</span><span class="p">,</span> <span class="s2">"IgnoreCase"</span><span class="p">).</span><span class="n">Groups</span><span class="p">[</span><span class="n">1</span><span class="p">].</span><span class="n">Value</span>

       <span class="k">if</span> <span class="p">(</span><span class="nv">$rel</span> <span class="o">-eq</span> <span class="s2">"nuget"</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">Discover-PackageSources</span> <span class="n">-Url</span> <span class="nv">$match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="n">1</span><span class="p">].</span><span class="n">Value</span><span class="p">.</span><span class="n">Trim</span><span class="p">()</span> <span class="n">-Username</span> <span class="nv">$Username</span> <span class="n">-Password</span> <span class="nv">$Password</span> <span class="n">-Title</span> <span class="nv">$title</span>
       <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="nv">$xml</span> <span class="p">=</span> <span class="no">[xml]</span><span class="nv">$data</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$xml</span><span class="p">.</span><span class="n">service</span> <span class="o">-ne</span> <span class="nv">$null</span><span class="p">)</span> <span class="p">{</span>
            <span class="c"># Regular feed</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$Title</span> <span class="o">-eq</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$Title</span> <span class="p">=</span> <span class="nb">Split-Path</span> <span class="nv">$Url</span> <span class="n">-Leaf</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">((</span><span class="nb">Get-PackageSource</span> <span class="n">-Name</span> <span class="nv">$Title</span><span class="p">)</span> <span class="o">-eq</span> <span class="nv">$null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">Add-PackageSource</span> <span class="n">-Name</span> <span class="nv">$Title</span> <span class="n">-Source</span> <span class="nv">$Url</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$xml</span><span class="p">.</span><span class="n">rsd</span> <span class="o">-ne</span> <span class="nv">$null</span><span class="p">)</span> <span class="p">{</span>
            <span class="c"># RSD document</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$service</span> <span class="k">in</span> <span class="nv">$xml</span><span class="p">.</span><span class="n">rsd</span><span class="p">.</span><span class="n">service</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">Get-PackageSource</span> <span class="n">-Name</span> <span class="nv">$service</span><span class="p">.</span><span class="n">title</span><span class="p">)</span> <span class="o">-eq</span> <span class="nv">$null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$endpoint</span> <span class="k">in</span> <span class="nv">$service</span><span class="p">.</span><span class="n">apis</span><span class="p">.</span><span class="n">api</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nv">$endpoint</span><span class="p">.</span><span class="n">name</span> <span class="o">-eq</span> <span class="s2">"nuget-v2-packages"</span> <span class="o">-and</span> <span class="nv">$endpoint</span><span class="p">.</span><span class="n">preferred</span> <span class="o">-eq</span> <span class="s2">"true"</span> <span class="p">)</span> <span class="p">{</span>
                            <span class="nb">Add-PackageSource</span> <span class="n">-Name</span> <span class="nv">$service</span><span class="p">.</span><span class="n">title</span> <span class="n">-Source</span> <span class="nv">$endpoint</span><span class="p">.</span><span class="n">apiLink</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/myget">myget</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>